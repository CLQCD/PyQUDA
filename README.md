# PyQUDA

Python wrapper for [QUDA](https://github.com/lattice/quda) written in Cython.

This project aims to benifit from the optimized linear algebra library [CuPy](https://github.com/cupy/cupy) in Python based on CUDA. CuPy and QUDA will allow us to do most operation in lattice QCD research with high performance. [PyTorch](https://github.com/pytorch/pytorch) is an alternative option.

This project is based on the latest QUDA develop branch. PyQUDA should be compatible with any commit of QUDA after May 2023, but leave some features disabled.

## Installation

### Install QUDA

You need to build and install QUDA as the prerequisite.

This is an example to build and install QUDA for multiple GPUs. The default install directory of QUDA should be `/path/to/quda/build/usqcd`. Here most fermion actions are disabled because PyQUDA doesn't support them now.

```bash
git clone https://github.com/lattice/quda.git
mkdir -p quda/build
pushd quda/build
cmake .. -DCMAKE_BUILD_TYPE=RELEASE -DQUDA_CLOVER_DYNAMIC=OFF -DQUDA_CLOVER_RECONSTRUCT=OFF -DQUDA_DIRAC_DOMAIN_WALL=OFF -DQUDA_DIRAC_NDEG_TWISTED_CLOVER=OFF -DQUDA_DIRAC_NDEG_TWISTED_MASS=OFF -DQUDA_DIRAC_TWISTED_CLOVER=OFF -DQUDA_DIRAC_TWISTED_MASS=OFF -DQUDA_MULTIGRID=ON -DQUDA_MPI=ON -DQUDA_LAPLACE=ON
cmake --build . -j12
cmake --install .
popd
```

### Install PyQUDA

Install PyQUDA with your Python interpreter.
Here we set `QUDA_PATH` to the install directory of QUDA.

```bash
git clone https://github.com/CLQCD/PyQUDA.git
cd PyQUDA
export QUDA_PATH=../quda/build/usqcd
python3 -m pip install .
```

### Install CuPy or PyTorch

PyQUDA doesn't list `cupy` or `torch` as dependency because of the different names of the precompiled binary packages. At least one of them is required by the project, and you should install one of them manually.

You should choose **ONE OF** commands below depends on your CUDA toolkit version to install CuPy package.

```bash
python3 -m pip install "cupy>=12" # build from source, not recommand
python3 -m pip install "cupy-cuda110>=12" # for CUDA v11.0
python3 -m pip install "cupy-cuda111>=12" # for CUDA v11.1
python3 -m pip install "cupy-cuda11x>=12" # for CUDA v11.2 ~ v11.8
python3 -m pip install "cupy-cuda12x>=12" # for CUDA v12.x
```

Or use command blow to install PyTorch package.

```bash
python3 -m pip install "torch>=2"
```

### Test PyQUDA

[Chroma](https://github.com/JeffersonLab/chroma) is needed here for generating the reference files used by test scripts.
A precompiled Chroma is included in the repository, and you need to fetch it with `git-lfs`. Note that `git<2` seems not work well with `git-lfs`.

```bash
git lfs install
git lfs pull
```

The reference files used by test scripts should be generated by running Chroma with `test.*.ini.xml`. Then the corresponding Python script `test.*.py` should check the QUDA result with Chroma.

```bash
tests/bin/chroma -i tests/test.clover.ini.xml
python3 tests/test.clover.py
```

Or just run the Python script that automatically calls Chroma.

```bash
python3 tests/test.clover.chroma.py
```

You may also want to initialize `pyquda` with cli arguments instead of hardcoding them in scripts:

```bash
python3 -m pyquda tests/test.clover.cli.py --latt 4 4 4 8 --t-boundary -1 --anisotropy 2.593684210526316 --backend cupy
```

or just run the script as arguments are written in the shebang line:

```bash
./tests/test.clover.cli.py
```

## Development

I recommand you to build PyQUDA using inplace mode instead of installing PyQUDA.

```bash
git clone https://github.com/CLQCD/PyQUDA.git
cd PyQUDA
export QUDA_PATH=../quda/build/usqcd
python3 -m pip install -r requirements.txt
python3 -m pip install "Cython>=3"
python3 setup.py build_ext --inplace
```

Now you can modify Python files in the project and immediately get the new result by running scripts. Adding the root directory to `sys.path` list is needed if you are running scripts from other directories.

## Maintenance

Function definitions (mainly in `quda.in.pxd` and `pyquda.in.pyx`) and most docstrings (mainly in `pyquda.pyi` and `enum_quda.in.py`) should be manually updated as they cannot be autogenerated now. This also means PyQUDA should work well on any QUDA where the function interface remains unchanged.
