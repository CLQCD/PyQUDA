# 简介与示例

## 0. Environment configuration

*We recommand using Python standard library `venv` instead of `conda` to manage your virtual environment.*

### a. Ensure Python version >= 3.7

```bash
python3 --version
```

### b. Initialize a vritual environment of Python.

venv version:
```bash
python3 -m venv .venv
```

conda version:
```bash
conda create .venv
```

### c. Activate the virtual environment

venv version:
```bash
source .venv/bin/activate
```

conda version:
```bash
conda activate .venv
```

### d. Install prerequisites

```bash
pip install numpy mpi4py
```

#### i. Install CuPy with CUDA Toolkit
Install prebuilt CuPy with your CUDA Toolkit version
```bash
pip install cupy-cuda110
pip install cupy-cuda111
pip install cupy-cuda11x
pip install cupy-cuda12x
```

#### ii. Install CuPy with DTK

Download the source code of CuPy version 12.3.0
```bash
wget https://github.com/cupy/cupy/releases/download/v12.3.0/cupy-12.3.0.tar.gz
tar -xzvf cupy-12.3.0.tar.gz
cd cupy-12.3.0
```

Apply the patch
```diff
diff --git a/install/cupy_builder/_features.py b/install/cupy_builder/_features.py
index d12de78c3..8c9ac830a 100644
--- a/install/cupy_builder/_features.py
+++ b/install/cupy_builder/_features.py
@@ -173,7 +173,7 @@ def get_features(ctx: Context) -> Dict[str, Feature]:
             'hiprand',
             'hipsparse',
             'rocfft',
-            'roctx64',
+            #'roctx64',
             'rocblas',
             'rocsolver',
             'rocsparse',
```

Build and install CuPy from source
```bash
export CUPY_INSTALL_USE_HIP=1
export ROCM_HOME=/path/to/dtk-23.10
pip install .
```

### e. Build QUDA

#### i. From source

```bash
git clone https://github.com/lattice/quda.git
mkdir build && cd build
cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
    -DCMAKE_BUILD_TYPE=RELEASE \
    -DQUDA_GPU_ARCH=${GPU_TARGET} \
    -DQUDA_HETEROGENEOUS_ATOMIC=${HETEROGENEOUS_ATOMIC} \
    -DQUDA_MPI=ON \
    -DQUDA_CONTRACT=ON \
    -DQUDA_COVDEV=ON \
    -DQUDA_CLOVER_DYNAMIC=OFF \
    -DQUDA_CLOVER_RECONSTRUCT=OFF \
    -DQUDA_DIRAC_CLOVER_HASENBUSCH=OFF \
    -DQUDA_DIRAC_DOMAIN_WALL=OFF \
    -DQUDA_DIRAC_TWISTED_CLOVER=OFF \
    -DQUDA_DIRAC_TWISTED_MASS=OFF \
    -DQUDA_DIRAC_NDEG_TWISTED_CLOVER=OFF \
    -DQUDA_DIRAC_NDEG_TWISTED_MASS=OFF \
    -DQUDA_LAPLACE=ON -DQUDA_MULTIGRID=ON \
    -DQUDA_MULTIGRID_NVEC_LIST="6,24,32,64,96" \
    ..
cmake --build . -j16 && cmake --install .
```

#### ii. Using Build-USQCD-SciDAC repo

```bash
git clone https://github.com/SaltyChiang/Build-USQCD-SciDAC.git
cd Build-USQCD-SciDAC
./pyquda.sh dtk
scp scidac.tgz remote:~/
```

```bash
ssh remote
tar -xzvf scidac.tgz
cd scidac
./build_pyquda.sh
```

You should edit the first few lines to match your devices.
```
BUILD_SHAREDLIB=ON
GPU_TARGET=gfx906
HETEROGENEOUS_ATOMIC=OFF
LLVM_VERSION=15  # Match the LLVM version shipped with DTK
JOBS=16  # Match the number of CPU cores
QUDA_JOBS=16  # Match the number of CPU cores (Reduce this if the memory is limited)
OFFLINE=1  # Should be 1 if the host is offline
```

### f. Build and install PyQUDA

```bash
git clone --recursive https://github.com/CLQCD/PyQUDA.git
cd PyQUDA.git
export QUDA_PATH=/path/to/scidac/install/pyquda-${GPU_TARGET}
pip install .
```

Make sure everything is fine
```bash
./tests/bin/chroma -i tests/test.clover.ini.xml
python3 tests/test.clover.py
```

### g. Use QUDA functions in Python

Most functions in `quda.h` could be used by PyQUDA
```bash
from pyquda import quda

quda.initQuda(-1)
quda.endQuda()
```

## 0.5. Basic of PyQUDA

### `LatticeInfo`

`LatticeInfo` is used to handle the basic information including size, grid, t boundary condition and anisotropy of a lattice.

Most class in PyQUDA shoule use `LatticeInfo` as the input to instantiate a object.

### `LatticeGauge`

`LatticeGauge` is the class to handle the gauge data along with some utility pure gauge functions such as gauge fixing and smearing. A `LatticeGauge` is usually generated by `io.readGauge`.

#### `LatticeGauge.data`
Could be `numpy.ndarray`, `cupy.ndarray` or `torch.Tensor` with dtype `complex128` and shape `(Nd, 2, Lt, Lz, Ly, Lx // 2, Nc, Nc)`, row-column order.

### `LatticePropagator`

A `LatticePropagator` is usually generated by `source` and `invert` functions.

#### `LatticePropagator.data`
Could be `numpy.ndarray`, `cupy.ndarray` or `torch.Tensor` with dtype `complex128` and shape `(2, Lt, Lz, Ly, Lx // 2, Ns, Ns, Nc, Nc)`, row-column order.

### `LatticeFermion`

A `LatticeFermion` should always be a intermediate variant.

#### `LatticeFermion.data`
Could be `numpy.ndarray`, `cupy.ndarray` or `torch.Tensor` with dtype `complex128` and shape `(2, Lt, Lz, Ly, Lx // 2, Ns, Nc)`, row-column order.

## 1. Quenched HMC and dynamical HMC (Optional)

```bash
python3 1.py
```

## 2. 在产生的规范场组态上做HYP smearing，然后算静态势并大致估计格距

## 3. 在HYP smeared的组态上跑clover传播子（csw=1），计算pion和nucleon的2pt（mpi～300 MeV，700MeV，3000MeV）

## 4. 基于PCAC计算三种pion mass下的quark mass

## 5. 计算不同动量的2pt，确定色散关系，计算quasi-DA矩阵元（可选）

## 6. 计算seq source，计算nucleon的gV和gA

## 7. 计算quasi-PDF矩阵元（可选）
